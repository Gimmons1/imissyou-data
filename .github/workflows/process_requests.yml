name: Processa Richieste Admin App

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process_admin_command:
    if: startsWith(github.event.issue.title, 'REQUEST:') || startsWith(github.event.issue.title, 'USER_REQUEST:') || startsWith(github.event.issue.title, 'ADMIN_REQUEST:') || startsWith(github.event.issue.title, 'APPROVE') || startsWith(github.event.issue.title, 'DELETE')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del codice sorgente
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # FIX: Scarica la cronologia per evitare conflitti

      - name: Configurazione Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Installa dipendenze
        run: pip install requests

      - name: Esecuzione comando Admin
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: python request_processor.py

      - name: Salva il database aggiornato
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "⚡ Aggiornamento Database Admin da App"
          file_pattern: "library.json"
          push_options: '--force' # FIX: Forza il salvataggio sovrascrivendo i blocchi

      - name: Chiudi il Ticket elaborato
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "✅ Comando elaborato e salvato."
